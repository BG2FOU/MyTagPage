import{M as F}from"./components/MapboxPanel/MainPanel-Bs9Iso0D.js";import{M as b}from"./components/MapboxComponent/MapboxMain-D_Dloo87.js";import{_ as J}from"./components/DataProcess/DataHandler-BdsYUxZ9.js";import{i as X}from"./components/MapboxPanel/itemsManage-BYUkpJBb.js";import{_ as j}from"./components/localStorage-DI3hWFE7.js";import{_ as H}from"./components/ElementComponent/ElementMessage-I7Bpnka3.js";import{u as I}from"./components/MapboxPanel/stores/deviceStore-C0BIN_ip.js";import{_ as T}from"./components/DataProcess/exportGPX-CYrAdL3r.js";import{r as d,b as B,d as q,o as $,e as p,F as A,f as _,E as W}from"../vendor-UN2rW63P.js";const te={__name:"MainApp",setup(C){const t=d(null),r=d(null),c=d({}),x=d(null),i=d(!1),g=d(!1),y=d({}),h=d(null),m=I(),f={layers:["findmy-point","findmy-route","line-arrows","findmy-heatmap"],sources:["findmy-data"]},v=e=>{(!e||!e.features||e.features.length===0)&&W("无数据")},D=e=>{c.value.data=e,v(e),c.value.status="GeoJSONLayers",t.value.removeGeoJSONLayers(f.layers,f.sources),t.value.addGeoJSONLayers(e),t.value.FitBounds(e)},S=e=>{c.value.data=e,c.value.status="HeatMap",t.value.removeGeoJSONLayers(f.layers,f.sources),t.value.addHeatmapLayer(e),t.value.FitBounds(e)},R=async e=>{t.value.existingLayers.clear(),i.value=!0,e.mode="timerange",await r.value.fetchData(e),i.value=!1;const a=r.value.exposedData;D(a)},P=async e=>{t.value.existingLayers.clear(),i.value=!0,e.mode="timerange",await r.value.fetchData(e),i.value=!1;const a=r.value.exposedData;v(a),S(a)},k=async e=>{t.value.existingLayers.clear(),i.value=!0;const a={...e};a.dateTimeRange=[],a.mode="realtime",await r.value.fetchData(a),i.value=!1;const o=r.value.exposedData,s=JSON.parse(JSON.stringify(o)),n=M(s);y.value.data=n,v(o),t.value.removeMarkers(),t.value.addRealtimeMarker(n),t.value.FitBounds(n)},G=async()=>{const e=m.propsMap,a=_({idSelected:[],dateTimeRange:[],mode:"realtime"});if(e&&Object.keys(e).length){Object.values(e).forEach(l=>{a.idSelected.push(...l.privateKey)}),await r.value.fetchData(a);const o=r.value.exposedData,s=JSON.parse(JSON.stringify(o)),n=M(s);y.value.data=n,v(o),t.value.removeMarkers(),t.value.addRealtimeMarker(n),t.value.FitBounds(n)}},L=e=>{t.value.existingLayers.clear(),i.value=!0,e.mode="timerange",r.value.fetchData(e).then(()=>{i.value=!1;const a=r.value.exposedData;c.value.data=a,h.value.exportFullGPX()})},O=e=>{t.value.existingLayers.clear(),i.value=!0,e.mode="timerange",r.value.fetchData(e).then(()=>{i.value=!1;const a=r.value.exposedData;c.value.data=a,h.value.exportWaypointsGPX()})};function M(e){const a=[];e.features.forEach(l=>{l.geometry.type==="Point"&&a.push(l)});const o={};a.forEach(l=>{const u=l.properties.id;o[u]||(o[u]=[]),o[u].push(l)});const s=[];for(const l in o)if(o.hasOwnProperty(l)){const u=o[l];u.sort((E,N)=>new Date(N.properties.TimeStamp)-new Date(E.properties.TimeStamp)),s.push(u[0])}return{type:"FeatureCollection",features:[...s]}}const w=async()=>{const e=m.propsMap;g.value=!0;const a=_({idSelected:[],dateTimeRange:[],mode:"realtime"});Object.values(e).forEach(s=>{a.idSelected.push(...s.privateKey)});const o=await r.value.fetchData(a);g.value=!1,o.data&&o.data.forEach(s=>{if(!e[s.id_short])return;const n=e[s.id_short],l=s.isodatetime,u=n.Lastupdate;(!u||u=="N/A"||l>u)&&(n.Lastupdate=l,n.Coordinate=[s.longitude,s.latitude],n.Location=[s.longitude,s.latitude])})};return B(()=>{Object.assign(m.propsMap,m.readLocalstorage()),G()}),(e,a)=>($(),q(A,null,[p(F,{loading:i.value,onSubmit:R,onAddHeatMap:P,onRealtime:k,onExportFullGPX:L,onExportWaypointsGPX:O},null,8,["loading"]),p(X,{loading:g.value,onReqUpdateItemProps:w},null,8,["loading"]),p(b,{geodata:c.value,realtimemarker:y.value,ref_key:"MapboxMainRef",ref:t},null,8,["geodata","realtimemarker"]),p(J,{ref_key:"DataHandlerRef",ref:r},null,512),p(j),p(T,{geojsonData:c.value,ref_key:"exportGPXRef",ref:h},null,8,["geojsonData"]),p(H,{ref_key:"ElementMessageRef",ref:x},null,512)],64))}};export{te as _};
