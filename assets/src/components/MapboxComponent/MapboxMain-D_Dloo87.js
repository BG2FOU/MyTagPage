import{r as g,q as f,b as pe,i as q,d as U,o as V,k as C,e as O,j as Y,F as de,s as ue,t as ce,v as i,x as me,M as ge}from"../../../vendor-UN2rW63P.js";import{_ as fe}from"../DataProcess/DataHandler-BdsYUxZ9.js";import{u as ve}from"../MapboxPanel/stores/deviceStore-C0BIN_ip.js";import{_ as ye}from"../../../plugin-vue_export-helper-DlAUqK2U.js";const he={id:"menu"},be={class:"input-label-row"},xe=["id","value","checked"],Se=["for"],K="streets",$e={__name:"MapboxMain",props:{geodata:{type:Object,default:{}},realtimemarker:{type:Object,default:{}}},setup(X,{expose:Q}){const y=ve(),T=g(null),t=g(null),ee=g(null);let b=!1;const u=g("WGS84"),w={ar:"ar",de:"de",en:"en",es:"es",fr:"fr",it:"it",ja:"ja",ko:"ko",mul:"mul",pt:"pt",ru:"ru",vi:"vi","zh-CN":"zh-Hans","zh-HK":"zh-Hant","zh-TW":"zh-Hant","zh-Hans":"zh-Hans","zh-Hant":"zh-Hant"},k=[],m=new Set,M=g(K),te="pk.eyJ1IjoiZ2Vla2NhdCIsImEiOiJjbHc5ZTJ6dmIwMTEyMmpudGowMXk5Y3o2In0.HDxYFBSNCpbYan731GLJEw",h=g(null),v=g(!1),_=[{id:"satellite-streets",label:"mapbox卫星地图",url:"mapbox://styles/geekcat/clwc44om0008b01pn91yg82cg"},{id:"light-v11",label:"mapbox Light",url:"mapbox://styles/mapbox/light-v11"},{id:"dark-v11",label:"mapbox Dark",url:"mapbox://styles/mapbox/dark-v11"},{id:"streets",label:"mapbox街道地图",url:"mapbox://styles/geekcat/clwxb0z8q01ep01pohp1h4q4d"},{id:"outdoors",label:"mapbox户外地图",url:"mapbox://styles/geekcat/clwxbnita01es01po7fto915q"},{id:"amap",label:"高德地图",url:{version:8,glyphs:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",sources:{"raster-tiles":{type:"raster",tiles:["https://webrd04.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"],tileSize:256}},layers:[{id:"amap-tiles",type:"raster",source:"raster-tiles",minzoom:0,maxzoom:24}]}}],J=X,G=()=>{const s=navigator.language||navigator.userLanguage,a=navigator.language.split("-")[0];let r="mul";a=="zh"&&w[s]&&(r=w[s]),a!=="zh"&&w[a]&&(r=w[a]),h.value||(f.setRTLTextPlugin("https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.3/mapbox-gl-rtl-text.js"),h.value=new ge({defaultLanguage:r})),t.value.language=r,t.value.setStyle(h.value.setLanguage(t.value.getStyle(),r)),t.value.addControl(h.value)};g(/iPhone|iPad|iPod/i.test(navigator.userAgent));const ae=g(/android/i.test(navigator.userAgent)),z=g(!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)),N=(s,a,r,e)=>{let o=a,n=r;const p=JSON.parse(JSON.stringify([a,r]));if(u.value=="WGS84"){const d=i.transform(p,i.WGS84,i.GCJ02);o=d[0],n=d[1]}let l="";switch(console.log("name",e),s){case"amap":ae.value?(l=`androidamap://viewMap?lat=${n}&lon=${o}&poiname=${e}`,window.location.href=l):z.value?l=`https://uri.amap.com/marker?position=${o},${n}`:(l=`iosamap://viewMap?lat=${n}&lon=${o}&name=${e}`,window.location.href=l);break;case"baidu":if(u.value=="GCJ02"){const d=i.transform(p,i.GCJ02,i.BD09);o=d[0],n=d[1]}else if(u.value=="WGS84"){const d=i.transform(p,i.WGS84,i.BD09);o=d[0],n=d[1]}z.value?l=`https://api.map.baidu.com/marker?location=${n},${o}&title=${e}&content=${e}&output=html&src=webapp.baidu.openAPIdemo`:l=`baidumap://map/marker?location=${n},${o}&title=${e}`;break;case"apple":l=`http://maps.apple.com/?daddr=${n},${o}`;break;case"normal":if(u.value=="GCJ02"){const d=i.transform(p,i.GCJ02,i.WGS84);o=d[0],n=d[1]}l=`geo:${n},${o}?q=${n},${o}(${e})`;break}/MicroMessenger/i.test(navigator.userAgent)?(l=`https://uri.amap.com/marker?position=${o},${n}`,window.location.href=l):!s=="baidu"&&!z.value?window.location.href=l:window.open(l,"_blank"),setTimeout(()=>{if(!document.hidden)switch(s){case"amap":window.open(`https://uri.amap.com/marker?position=${o},${n}`,"_blank");break;case"baidu":window.open(`https://api.map.baidu.com/marker?location=${n},${o}&title=${e}&content=${e}&output=html&src=webapp.baidu.openAPIdemo`,"_blank");break}},2e3)},E=s=>{const a=s.target.value;M.value=a;const r=_.find(e=>e.id===a).url;if(localStorage.setItem("mapStyle",a),t.value){a==="amap"?(u.value="GCJ02",v.value==!0&&(t.value.removeControl(L),v.value=!1),t.value.removeControl(h.value)):(u.value="WGS84",v.value==!1&&(t.value.addControl(L),v.value=!0));try{t.value.setStyle(r)}catch(e){console.error("Error setting map style:",e)}t.value.once("style.load",()=>{for(const e of m)t.value.getLayer(e)&&t.value.removeLayer(e);t.value.getSource("findmy-data")&&t.value.removeSource("findmy-data"),(m.has("findmy-point")||m.has("findmy-route")||m.has("line-arrows"))&&W(J.geodata.data),m.has("findmy-heatmap")&&I(J.geodata.data),k.length>0&&(Z(),A(J.realtimemarker.data)),a!=="amap"&&G()})}},F=s=>{const a=["match",["get","id"]];return Object.entries(s).length>0&&Object.entries(s).forEach(([e,o])=>{a.push(e,o)}),a.push("#B42222"),a},oe=()=>"#"+Math.floor(Math.random()*16777215).toString(16).padStart(6,"0"),I=s=>{const a=JSON.parse(JSON.stringify(s));u.value==="GCJ02"&&s&&i.transform(a,i.WGS84,i.GCJ02),Object.keys(s).length!=0&&(t.value.getSource("findmy-data")||t.value.addSource("findmy-data",{type:"geojson",data:a}),t.value.getLayer("findmy-heatmap")||t.value.addLayer({id:"findmy-heatmap",type:"heatmap",source:"findmy-data",maxzoom:17,paint:{"heatmap-intensity":["interpolate",["linear"],["zoom"],0,1,9,3,15,10],"heatmap-color":["interpolate",["linear"],["heatmap-density"],0,"rgba(33,102,172,0)",.2,"rgb(103,169,207)",.4,"rgb(209,229,240)",.6,"rgb(253,219,199)",.8,"rgb(239,138,98)",1,"rgb(178,24,43)"],"heatmap-radius":["interpolate",["linear"],["zoom"],0,2,9,15],"heatmap-opacity":["interpolate",["linear"],["zoom"],0,.6,10,.7,17,1]},filter:["==","$type","Point"]}),m.add("findmy-heatmap"))},W=s=>{const a=JSON.parse(JSON.stringify(s));if(Object.keys(s).length==0)return;me(s),u.value==="GCJ02"&&s&&i.transform(a,i.WGS84,i.GCJ02);const r={},e={};Object.entries(y.propsMap).forEach(p=>{const[l,d]=p;r[l]=d.pointColor,e[l]=d.lineColor});const o=F(r),n=F(e);t.value.getSource("findmy-data")||t.value.addSource("findmy-data",{type:"geojson",data:a}),t.value.getLayer("findmy-point")||(t.value.addLayer({id:"findmy-point",type:"circle",source:"findmy-data",paint:{"circle-radius":6,"circle-color":o},filter:["==","$type","Point"]}),m.add("findmy-point")),t.value.getLayer("findmy-route")||(t.value.addLayer({id:"findmy-route",type:"line",source:"findmy-data",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":n,"line-width":3,"line-dasharray":[1,2]},filter:["==","$type","LineString"]}),m.add("findmy-route")),t.value.getLayer("line-arrows")||(t.value.addLayer({id:"line-arrows",type:"symbol",source:"findmy-data",layout:{"symbol-placement":"line","text-field":"▶","text-size":24,"symbol-spacing":50,"text-keep-upright":!1},paint:{"text-color":"red"},filter:["==","$type","LineString"]}),m.add("line-arrows"))},B=(s,a)=>{s.forEach(r=>{t.value.getLayer(r)&&t.value.removeLayer(r)}),a.forEach(r=>{t.value.getSource(r)&&t.value.removeSource(r)})},ne=s=>{const a=JSON.parse(JSON.stringify(s));if(u.value==="GCJ02"&&s&&i.transform(a,i.WGS84,i.GCJ02),!a||!a.features||a.features.length===0){console.warn("No features found in geodata for FitBounds.");return}const r=new f.LngLatBounds;a.features.forEach(function(e){const o=e.geometry.coordinates;e.geometry.type==="Point"&&r.extend(o)}),r.isEmpty()||t.value.fitBounds(r,{padding:20,maxZoom:15})},se=s=>{const a=["in",["get","name"],["literal",s]];t.value.setFilter("findmy-point",a),t.value.setFilter("findmy-route",a),t.value.setFilter("line-arrows",a),b=!0},re=()=>{t.value.setFilter("findmy-point",null),t.value.setFilter("findmy-route",null),t.value.setFilter("line-arrows",null),b=!1},A=s=>{const a=JSON.parse(JSON.stringify(s));if(!a||!a.features||a.features.length===0){console.warn("No features found in geodata for adding markers.");return}u.value==="GCJ02"&&s&&i.transform(a,i.WGS84,i.GCJ02);for(const r of a.features){const e=r.properties.id,o=document.createElement("div");o.className="marker";const n=document.createElement("div");if(n.className="markerWrapper",n.style.backgroundColor=y.propsMap[e].bgColor||oe(),n.innerHTML='<div class="emoji-wrapper">🌏</div>',y.propsMap[e].emoji){const H=y.propsMap[e].emoji;n.innerHTML=`<div class="emoji-wrapper">${H}</div>`}o.appendChild(n);const p=y.propsMap[e].name,l=r.geometry.coordinates,x=l.map(H=>H.toFixed(4).toString()).join(","),c=r.properties.TimeStamp,S=r.properties.Status,$=`
  <div class="custom-popup open-diag">
  <strong>名称:</strong> ${p}<br/>
  <strong>位置:</strong> ${x}<br/>
  <strong>时间点:</strong> ${c}<br/>
  <strong>${j(S).fullStatus}</strong>
  <div class="action-buttons" style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
    <button class="open-amap" data-lng="${l[0]}" data-lat="${l[1]}" data-name="${p}" 
            style="padding: 6px 12px; height: 32px; line-height: 20px;">
      🧭 在高德地图中打开
    </button>
    <button class="open-baidu" data-lng="${l[0]}" data-lat="${l[1]}" data-name="${p}" 
            style="padding: 6px 12px; height: 32px; line-height: 20px;">
      🗺️ 在百度地图中打开
    </button> 
    <button class="open-geo" data-lng="${l[0]}" data-lat="${l[1]}" data-name="${p}" 
            style="padding: 6px 12px; height: 32px; line-height: 20px;">
      🌐 在其他地图中打开
    </button> 
  </div>
</div>
`,P=new f.Popup({offset:25}).setHTML($),ie=new f.Marker(o).setLngLat(l).setPopup(P).addTo(t.value);k.push(ie)}},Z=()=>{if(k.length>0)for(const s of k)s.remove()};function D(){var s=t.value.getCenter(),a=t.value.getZoom();localStorage.setItem("mapCenter",JSON.stringify(s)),localStorage.setItem("mapZoom",a)}function R(){var s=JSON.parse(localStorage.getItem("mapCenter")),a=localStorage.getItem("mapZoom");s&&a&&(t.value.setCenter(s),t.value.setZoom(a))}const le=s=>{switch((s&192)>>>6){case 1:return"中等电量";case 2:return"低电量";case 3:return"严重低电量";default:return"电量充足"}},j=s=>{const a=le(s),r=s&63;return{batteryStatus:a,counter:r,fullStatus:`电池状态: ${a}<br>计数器: ${r}`}},L=new f.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0,showUserHeading:!0});return Q({map:t,switchStyle:E,setStyleLanguage:G,geometryColorSet:F,addHeatmapLayer:I,addGeoJSONLayers:W,removeGeoJSONLayers:B,setMapFilter:se,removeMapFilter:re,FitBounds:ne,addRealtimeMarker:A,removeMarkers:Z,existingLayers:m,MapFilterSet:b,MapCoordSystem:u,removeGeoJSONLayers:B,storeMapState:D,restoreMapState:R}),pe(()=>{const s=[104.0657,30.6594];f.accessToken=te;const r=localStorage.getItem("mapStyle")||K;M.value=r,document.body.addEventListener("click",e=>{if(e.target.classList.contains("open-amap")){e.stopPropagation();const o=parseFloat(e.target.dataset.lng),n=parseFloat(e.target.dataset.lat),p=e.target.dataset.name;N("amap",o,n,p)}else if(e.target.classList.contains("open-baidu")){e.stopPropagation();const o=parseFloat(e.target.dataset.lng),n=parseFloat(e.target.dataset.lat),p=e.target.dataset.name;N("baidu",o,n,p)}else if(e.target.classList.contains("open-geo")){e.stopPropagation();const o=parseFloat(e.target.dataset.lng),n=parseFloat(e.target.dataset.lat),p=e.target.dataset.name;N("normal",o,n,p)}}),t.value=new f.Map({container:T.value,style:_.find(e=>e.id===r).url,center:s,zoom:2,maxZoom:17}),t.value.addControl(new f.NavigationControl),t.value&&(r==="amap"?(u.value="GCJ02",v.value==!0&&(t.value.removeControl(L),v.value=!1),h.value&&t.value.removeControl(h.value)):(u.value="WGS84",v.value==!1&&(t.value.addControl(L),v.value=!0,t.value.on("load",()=>{G()})))),R(),t.value.on("moveend",function(){D()}),t.value.on("mouseenter","findmy-point",e=>{t.value.getCanvas().style.cursor="pointer";const o=b?1:0,n=e.features[o].geometry.coordinates.slice(),p=n.map(P=>P.toFixed(4).toString()),l=e.features[o].properties.TimeStamp,d=e.features[o].properties.Status,x=e.features[o].properties.id,c=y.propsMap[x].name,S=`
  <div class="custom-popup open-diag">
  <strong>名称:</strong> ${c}<br/>
  <strong>位置:</strong> ${p}<br/>
  <strong>时间点:</strong> ${l}<br/>
  <strong>${j(d).fullStatus}</strong>
  <div class="action-buttons" style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
    <button class="open-amap" data-lng="${n[0]}" data-lat="${n[1]}" data-name="${c}" 
            style="padding: 6px 12px; height: 32px; line-height: 20px;">
      🧭 在高德地图中打开
    </button>
    <button class="open-baidu" data-lng="${n[0]}" data-lat="${n[1]}" data-name="${c}" 
            style="padding: 6px 12px; height: 32px; line-height: 20px;">
      🗺️ 在百度地图中打开
    </button> 
    <button class="open-geo" data-lng="${n[0]}" data-lat="${n[1]}" data-name="${c}" 
            style="padding: 6px 12px; height: 32px; line-height: 20px;">
      🌐 在其他地图中打开
    </button> 
  </div>
</div>
`,$=new f.Popup({offset:25}).setLngLat(n).setHTML(S).addTo(t.value);t.value.on("mouseleave","findmy-point",()=>{t.value.getCanvas().style.cursor="",$.remove()})}),t.value.on("click","findmy-point",e=>{const o=b?1:0,n=e.features[o].geometry.coordinates.slice(),p=n.map($=>$.toFixed(4).toString()),l=e.features[o].properties.TimeStamp,d=e.features[o].properties.Status,x=e.features[o].properties.id,c=y.propsMap[x].name,S=`
  <div class="custom-popup open-diag">
  <strong>名称:</strong> ${c}<br/>
  <strong>位置:</strong> ${p}<br/>
  <strong>时间点:</strong> ${l}<br/>
  <strong>${j(d).fullStatus}</strong>
  <div class="action-buttons" style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
    <button class="open-amap" data-lng="${n[0]}" data-lat="${n[1]}" data-name="${c}" 
            style="padding: 6px 12px; height: 32px; line-height: 20px;">
      🧭 在高德地图中打开
    </button>
    <button class="open-baidu" data-lng="${n[0]}" data-lat="${n[1]}" data-name="${c}" 
            style="padding: 6px 12px; height: 32px; line-height: 20px;">
      🗺️ 在百度地图中打开
    </button> 
    <button class="open-geo" data-lng="${n[0]}" data-lat="${n[1]}" data-name="${c}" 
            style="padding: 6px 12px; height: 32px; line-height: 20px;">
      🌐 在其他地图中打开
    </button> 
  </div>
</div>
`;new f.Popup({offset:25}).setLngLat(n).setHTML(S).addTo(t.value)})}),(s,a)=>{const r=q("el-row"),e=q("el-col");return V(),U("div",null,[C("div",{id:"map",ref_key:"mapContainer",ref:T},null,512),O(fe,{ref_key:"DataHandlerRef",ref:ee},null,512),C("div",he,[O(e,null,{default:Y(()=>[(V(),U(de,null,ue(_,o=>O(r,{span:6,key:o.id},{default:Y(()=>[C("div",be,[C("input",{id:o.id,type:"radio",name:"rtoggle",value:o.id,checked:o.id===M.value,onChange:E},null,40,xe),C("label",{for:o.id},ce(o.label),9,Se)])]),_:2},1024)),64))]),_:1})])])}}},Me=ye($e,[["__scopeId","data-v-c96fe018"]]);export{Me as M};
