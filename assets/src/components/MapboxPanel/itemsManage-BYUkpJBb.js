import{r as f,J as L,b as ae,h as le,i as u,D as re,d as C,o as b,e as n,k as l,j as a,B as ie,G as pe,F as B,s as ce,p as M,a as de,l as _,P as ue,A as me,K as A,t as g,z as J,L as fe,E as d}from"../../../vendor-UN2rW63P.js";import{E as ve}from"./EditDeviceDialog-Cwg6MR1g.js";import{F as _e}from"./components/FileUpload-DAowMvcS.js";import{u as ge}from"./stores/deviceStore-C0BIN_ip.js";import{_ as ye}from"../../../plugin-vue_export-helper-DlAUqK2U.js";const he={class:"manageForm"},be={class:"justify-end"},we={class:"scrolldiv"},Ce={class:"itemsdiv"},ke={class:"card-inner"},xe={class:"Emoji"},Me={class:"item-prop"},Ne={class:"flex-prop"},Se={class:"flex-wrap"},je={key:0},Ke={class:"flex-prop"},De={class:"flex-wrap"},Ae={key:0},Fe={class:"single-line-text"},Ee={class:"single-line-text"},Ie={class:"main-layout-wrapper"},Oe={__name:"itemsManage",props:{propsMap:{type:Object,default:{}},loading:{type:Boolean,default:!1},jsonParsed:{type:Object,default:{}}},emits:["updateItemProps","reqUpdateItemProps"],setup(T,{emit:z}){const N=f(!1),S=f(!1),k=f("");f(new Set);const H=f(null),F=f(null);f(null);const E=T,r=ge(),I=L(()=>r.propsMap),q=L(()=>E.loading),G=z,O=t=>t?`background-color:${t}`:"",x=f(null),W=t=>{const e=new Map,p=new Map;for(const o of t){const s=new Set;o.privateKey&&(s.add(o.privateKey),p.set(o.privateKey,o.name)),o.additionalKeys.length>0&&o.additionalKeys.forEach(m=>{s.add(m),p.set(m,o.name)}),e.set(o.name,s)}for(const[o,s]of p.entries())r.keystoItemsMap.has(o)||r.keystoItemsMap.set(o,s);for(const[o,s]of e.entries())r.itemstoKeysMap.has(o)||r.itemstoKeysMap.set(o,s);for(const[o,s]of e.entries())r.propsMap.hasOwnProperty(o)||(r.propsMap[o]={emoji:"🌏",emojiName:"",emojiValue:"",bgColor:"#FFFFFF",pointColor:"red",lineColor:"blue",name:o,id:o,serialNum:"N/A",privateKey:[...s],pubKey:"",Lastupdate:"N/A",Added:new Date().toISOString(),Coordinate:["N/A","N/A"],Location:"N/A",commit:""});t&&typeof t=="object"?Object.assign(E.jsonParsed,t):console.error("解析的JSON数据格式不正确")},j=f("350px"),K=()=>{const t=window.innerWidth,e=window.innerHeight;j.value=e*.5+"px",t<=768&&(j.value=e*.6+"px")};ae(()=>{K(),window.addEventListener("resize",K)}),le(()=>{window.removeEventListener("resize",K)});const V=t=>{F.value={id:t,prop:r.propsMap[t]},S.value=!0},X=t=>{H.value=t},Q=t=>{delete r.propsMap[t],d({message:`${t}已删除`,type:"success",duration:2e3})},P=(t,e)=>{r.propsMap[e].emoji=t.i,r.propsMap[e].emojiName=t.n[0],r.propsMap[e].emojiValue=t.u},R=t=>{const e=new TextEncoder().encode(t),p=Array.from(e,o=>String.fromCharCode(o)).join("");return btoa(p)},Y=async t=>{const e={UUID:t,mode:"UUID"};try{const p=localStorage.getItem("serverAddress");if(p?x.value=p:console.warn("No server address found in localStorage"),!x.value){d.error("请设置服务器地址");return}const o=JSON.stringify(e),s=R(o);return await fetch(x.value,{method:"POST",headers:{"Content-Type":"application/json","X-Data-Encoding":"base64"},body:JSON.stringify({data:s})}).then(async c=>{if(!c.ok){const w=await c.text();throw new Error(w)}return c.json()})}catch(p){throw console.error("请求异常:",p),x.value?d.error(`数据获取失败: ${p}`):d.error("请设置服务器地址"),p}finally{}},U=()=>{var p,o;const t=k.value.trim();if(typeof t!="string"||fe.isEmpty(t)){d({message:"输入不能为空",type:"error",duration:2e3});return}if(/^[0-9a-f]{12}4[0-9a-f]{3}[89ab][0-9a-f]{15}$/i.test(t)){if(r.propsMap[t]){d({message:"该物品已存在",type:"warning",duration:2e3});return}Y(t).then(s=>{s&&(s==null?void 0:s.priv.length)>0?(r.propsMap[s.UUID]={emoji:"🌏",emojiName:"",emojiValue:"",bgColor:"#FFFFFF",pointColor:"red",lineColor:"blue",name:t,id:t,serialNum:"N/A",privateKey:[...s.priv],pubKey:"",Lastupdate:"N/A",Added:new Date().toISOString(),Coordinate:["N/A","N/A"],Location:"N/A",commit:""},d({message:`物品 ${t} 已添加`,type:"success",duration:2e3})):d.error("获取数据失败或物品序列号不正确")}).catch(s=>{console.error("Error fetching data:",s)})}else try{const s=JSON.parse(t);if(!((p=s[0])!=null&&p.name)||!((o=s[0])!=null&&o.privateKey))throw new Error("请输入正确的JSON密钥");const m=s[0].name,c=s[0].privateKey,w=new Set([c,...s[0].additionalKeys||[]]);if(Object.values(r.propsMap).flatMap(y=>y.privateKey).includes(c)){d({message:"私钥已存在",type:"warning",duration:2e3});return}r.propsMap[m]={emoji:"🌏",emojiName:"",emojiValue:"",bgColor:"#FFFFFF",pointColor:"red",lineColor:"blue",name:m,id:m,serialNum:"N/A",privateKey:[...w],pubKey:"",Lastupdate:"N/A",Added:new Date().toISOString(),Coordinate:["N/A","N/A"],Location:"N/A",commit:""},d({message:`设备 ${m} 已添加`,type:"success",duration:2e3})}catch(s){d.error(`输入格式错误: ${s.message}`);return}k.value=""},Z=()=>{G("reqUpdateItemProps",r.propsMap.value)},ee=()=>{Object.keys(r.propsMap).forEach(t=>{delete r.propsMap[t]}),d({message:"已删除所有物品",type:"success",duration:2e3})},$=t=>{navigator.clipboard.writeText(t).then(()=>{console.log("Copied to clipboard successfully!"),d({message:"已复制到剪贴板",type:"success"})},e=>{console.error("Could not copy text: ",e)})};return(t,e)=>{const p=u("el-input"),o=u("el-col"),s=u("CirclePlus"),m=u("el-icon"),c=u("el-button"),w=u("el-popconfirm"),D=u("el-row"),y=u("el-popover"),te=u("el-card"),oe=u("el-scrollbar"),se=u("el-dialog"),ne=re("loading");return b(),C(B,null,[n(se,{modelValue:N.value,"onUpdate:modelValue":e[1]||(e[1]=i=>N.value=i),title:"物品管理",draggable:"",width:"95%"},{default:a(()=>[l("div",he,[n(D,{gutter:10},{default:a(()=>[n(o,{xs:20,sm:12,md:8,class:"mb-col"},{default:a(()=>[n(p,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=i=>k.value=i),clearable:"",placeholder:"粘贴序列号或JSON密钥添加",onKeydown:ie(U,["enter"])},null,8,["modelValue"])]),_:1}),n(o,{xs:4,sm:4,md:2,class:"mb-col"},{default:a(()=>[n(c,{type:"primary",onClick:U,class:"full-width-btn"},{default:a(()=>[n(m,null,{default:a(()=>[n(s)]),_:1}),e[4]||(e[4]=l("span",{class:"hide-small"},"添加",-1))]),_:1,__:[4]})]),_:1}),n(o,{xs:10,sm:8,md:8},{default:a(()=>[n(_e,{onJsonParsed:W})]),_:1}),n(o,{xs:10,sm:4,md:4},{default:a(()=>[l("div",be,[n(w,{onConfirm:ee,title:"是否删除所有物品？"},{reference:a(()=>[n(c,{type:"danger",class:"icon-btn"},{default:a(()=>e[5]||(e[5]=[l("i",{class:"fa-solid fa-trash"},null,-1),l("span",{class:"hide-small"},"删除所有物品",-1)])),_:1,__:[5]})]),_:1})])]),_:1}),n(o,{xs:4,sm:4,md:2,class:"justify-end"},{default:a(()=>[n(c,{type:"primary",onClick:Z,class:"icon-btn"},{default:a(()=>e[6]||(e[6]=[l("i",{class:"fa-solid fa-rotate-right"},null,-1)])),_:1,__:[6]})]),_:1})]),_:1})]),n(oe,{"max-height":j.value},{default:a(()=>[pe((b(),C("div",we,[l("div",Ce,[n(D,{gutter:10},{default:a(()=>[(b(!0),C(B,null,ce(M(I),(i,h)=>(b(),de(o,{key:h,xs:24,sm:12,md:8,lg:6},{default:a(()=>[n(y,{ref_for:!0,ref:"popover",placement:"top",title:"Options",width:200,trigger:"contextmenu"},{reference:a(()=>[n(te,{class:"card",shadow:"hover",onClick:v=>V(h)},{default:a(()=>[l("div",ke,[n(y,{placement:"right",title:"Icon Picker",width:300,trigger:"click"},{reference:a(()=>[n(c,{class:"icon-div",onClick:A(v=>X(h),["stop"]),style:me(O(i.bgColor))},{default:a(()=>[l("div",xe,g(i.emoji),1)]),_:2},1032,["onClick","style"])]),default:a(()=>[n(M(ue),{native:!0,onSelect:v=>P(v,h)},null,8,["onSelect"])]),_:2},1024),l("div",Me,[l("div",Ne,[e[8]||(e[8]=_("物品名称: ")),n(y,{trigger:"hover",placement:"top"},{reference:a(()=>[l("div",Se,[_(g(i.name.substring(0,13))+" ",1),i.name.length>10?(b(),C("div",je,"... ")):J("",!0),n(c,{link:"",onClick:A(v=>$(i.name),["stop"])},{default:a(()=>e[7]||(e[7]=[l("i",{class:"fa-solid fa-copy"},null,-1)])),_:2,__:[7]},1032,["onClick"])])]),default:a(()=>[l("div",null,g(i.name),1)]),_:2},1024)]),l("div",Ke,[e[10]||(e[10]=_("密钥数量: ")),n(y,{trigger:"hover",placement:"top"},{reference:a(()=>[l("div",De,[_(g(i.privateKey.length)+" ",1),i.privateKey.length>10?(b(),C("div",Ae,"... ")):J("",!0),n(c,{link:"",onClick:A(v=>$(i.privateKey),["stop"])},{default:a(()=>e[9]||(e[9]=[l("i",{class:"fa-solid fa-copy"},null,-1)])),_:2,__:[9]},1032,["onClick"])])]),default:a(()=>[l("div",null,g(i.privateKey.slice(0,3)),1)]),_:2},1024)]),l("div",Fe,"位置: "+g(i.Location),1),l("div",Ee,"上次更新: "+g(i.Lastupdate),1)])])]),_:2},1032,["onClick"])]),default:a(()=>[l("div",null,[n(c,{onClick:v=>V(h)},{default:a(()=>e[11]||(e[11]=[_("编辑")])),_:2,__:[11]},1032,["onClick"]),n(c,{type:"danger",onClick:v=>Q(h)},{default:a(()=>e[12]||(e[12]=[_("删除")])),_:2,__:[12]},1032,["onClick"])])]),_:2},1536)]),_:2},1024))),128))]),_:1})])])),[[ne,M(q)]])]),_:1},8,["max-height"])]),_:1},8,["modelValue"]),n(ve,{modelValue:S.value,"onUpdate:modelValue":e[2]||(e[2]=i=>S.value=i),selectedDevice:F.value,iconBgColor:O,onSelectEmoji:P,PropsMap:M(I)},null,8,["modelValue","selectedDevice","PropsMap"]),l("div",Ie,[n(c,{class:"dail-button",type:"primary",onClick:e[3]||(e[3]=i=>N.value=!0)},{default:a(()=>e[13]||(e[13]=[l("i",{class:"fa-solid fa-box-archive",style:{"margin-right":"10px"}},null,-1),_("物品管理 ")])),_:1,__:[13]})])],64)}}},Be=ye(Oe,[["__scopeId","data-v-f7680b3d"]]);export{Be as i};
